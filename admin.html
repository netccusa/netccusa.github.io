<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #001226; color: white; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 1200px; display: flex; justify-content: flex-start; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; text-transform: uppercase; }
    
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; }
    .admin-container { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 8px; border-top: 3px solid #e2b13c; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
    
    h2 { text-transform: uppercase; letter-spacing: 2px; color: #e2b13c; font-size: 18px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
    
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #334e68; background: #001e3c; color: white; box-sizing: border-box; }
    .action-btn { background: #e2b13c; color: #001226; font-weight: bold; cursor: pointer; border: none; }
    
    .user-list-container { max-height: 500px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
    .log-queue { max-height: 400px; overflow-y: auto; }
    
    .card { background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 10px; border-left: 3px solid #e2b13c; font-size: 13px; }
    .btn-row { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
    
    .approve-btn { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; width: auto; border-radius: 3px; }
    .deny-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; width: auto; border-radius: 3px; }
    .view-btn { background: #334e68; color: white; border: none; padding: 5px 10px; cursor: pointer; width: auto; border-radius: 3px; }
    .reset-btn { background: #6b46c1; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; width: auto; border-radius: 3px; }
    .fire-btn { background: #e53e3e; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; width: auto; border-radius: 3px; }
    
    .req-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
    .req-grid input { padding: 5px; font-size: 11px; }
    label { font-size: 10px; color: #718096; text-transform: uppercase; }
    
    .role-select-mini { width: auto; padding: 2px; font-size: 11px; margin-top: 5px; background: #001226; border-color: #e2b13c; }
    .stats-block { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; }

    #typeList div { background: rgba(255,255,255,0.03); padding: 5px; margin-bottom: 3px; border-radius: 3px; display: flex; justify-content: space-between; }

    .history-container { grid-column: 1 / span 2; margin-top: 20px; }
    .history-table-wrapper { overflow-x: auto; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(226, 177, 60, 0.2); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: left; }
    th { background: rgba(226, 177, 60, 0.1); color: #e2b13c; padding: 12px; text-transform: uppercase; letter-spacing: 1px; }
    td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .status-badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .badge-approved { background: #28a745; color: white; }
    .search-input { margin-bottom: 10px; width: 300px; float: right; padding: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="nav-links"><a href="dashboard.html" class="btn-small">‚Üê Dashboard</a></div>

  <div class="admin-grid">
    <div>
      <div class="admin-container" style="border-top-color: #e2b13c;">
        <h2 style="color: #e2b13c;">Authorize Access</h2>
        <input type="email" id="inviteEmail" placeholder="Email Address">
        <input type="number" id="inviteRobloxId" placeholder="Roblox ID">
        <button class="action-btn" id="sendInviteBtn" style="background: #e2b13c;">Authorize Personnel</button>
      </div>

      <div class="admin-container">
        <h2>
          Personnel Management 
          <button class="fire-btn" id="resetAllWeeklyBtn" style="font-size: 9px;">RESET ALL WEEKLY</button>
        </h2>
        <div id="userList" class="user-list-container">Loading personnel...</div>
      </div>

      <div class="admin-container">
        <h2>Event Type Management</h2>
        <input type="text" id="newTypeName" placeholder="e.g. Basic Combat Training">
        <button class="action-btn" id="addTypeBtn" style="margin-top: 8px;">Add Event Type</button>
        <div id="typeList" style="margin-top:15px; font-size:12px;"></div>
      </div>
    </div>

    <div>
      <div class="admin-container">
        <h2>Promotion Requirements</h2>
        <select id="promoRankSelect"></select>
        <div class="req-grid">
          <div><label>Tryouts</label><input type="number" id="pReqTry" value="0"></div>
          <div><label>Bootcamps</label><input type="number" id="pReqBoot" value="0"></div>
          <div><label>Other</label><input type="number" id="pReqOther" value="0"></div>
          <div><label>Mins</label><input type="number" id="pReqMin" value="0"></div>
        </div>
        <button class="action-btn" id="savePromoBtn" style="margin-top:10px">Save Promotion Req</button>
      </div>

      <div class="admin-container" style="border-top-color: #e2b13c;">
        <h2 style="color: #e2b13c;">Weekly Quota Requirements</h2>
        <select id="quotaRankSelect"></select>
        <div class="req-grid">
          <div><label>Tryouts</label><input type="number" id="qReqTry" value="0"></div>
          <div><label>Bootcamps</label><input type="number" id="qReqBoot" value="0"></div>
          <div><label>Other</label><input type="number" id="qReqOther" value="0"></div>
          <div><label>Mins</label><input type="number" id="qReqMin" value="0"></div>
        </div>
        <button class="action-btn" id="saveQuotaBtn" style="margin-top:10px; background: #e2b13c;">Save Weekly Quota</button>
      </div>

      <div class="admin-container" style="border-top-color: #e2b13c;">
        <h2 style="color: #e2b13c;">Personnel Reform List</h2>
        <div id="reformList" class="user-list-container">Scanning for quota deficits...</div>
      </div>

      <div class="admin-container">
        <h2>Awaiting Approval</h2>
        <div id="logQueue" class="log-queue">No pending events.</div>
        <div id="minutesQueue" class="log-queue" style="margin-top:15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
      </div>
    </div>
    <div class="admin-container history-container">
      <h2>
        Event & Minutes History 
        <input type="text" id="historySearch" class="search-input" placeholder="Search by email...">
      </h2>
      <div class="history-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date Approved</th>
              <th>Personnel</th>
              <th>Type / Category</th>
              <th>Details</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, 
      updateDoc, deleteDoc, addDoc, getDocs, writeBatch, increment,
      query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ranks = [
      "Probationary Navy Instructor", "Junior Navy Instructor I", "Junior Navy Instructor II",
      "Navy Instructor I", "Navy Instructor II", "Navy Instructor III", "Senior Navy Instructor",
      "Head Navy Instructor I", "Head Navy Instructor II", "Deputy Chief Navy Instructor I",
      "Deputy Chief Navy Instructor II", "Chief Navy Instructor", "HICOM", "Deputy Director",
      "Director", "Headquarters", "SECNAV", "Commander in Chief", "Admin"
    ];

    let currentAdminRankIndex = -1;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (!userSnap.exists()) return window.location.replace("dashboard.html");
      
      const myRole = userSnap.data()?.role || "";
      currentAdminRankIndex = ranks.indexOf(myRole);

      const staff = ["hicom", "deputy director", "director", "headquarters", "secnav", "commander in chief", "admin"];
      if (!staff.includes(myRole.toLowerCase())) return window.location.replace("dashboard.html");

      initDropdowns();
      loadUsers();
      loadEventTypes();
      loadPendingLogs();
      loadPendingMinutes();
      loadReformList();
      loadHistory();
    });

    function initDropdowns() {
      const pSel = document.getElementById("promoRankSelect");
      const qSel = document.getElementById("quotaRankSelect");
      ranks.forEach(r => {
        let o1 = document.createElement("option"); o1.value = r; o1.textContent = r; pSel.appendChild(o1);
        let o2 = document.createElement("option"); o2.value = r; o2.textContent = r; qSel.appendChild(o2);
      });
    }

    // --- Core Management Logic ---

    document.getElementById("sendInviteBtn").onclick = async () => {
      const email = document.getElementById("inviteEmail").value.trim().toLowerCase();
      const rid = document.getElementById("inviteRobloxId").value;
      
      if (!email || !rid) return alert("Fill all fields");

      try {
        // We use the email as the Document ID to prevent duplicate invites for one person
        await setDoc(doc(db, "pending_invites", email), {
          robloxUserId: rid,
          invitedAt: new Date(), // Firebase Timestamp
          invitedBy: auth.currentUser.email // Tracking who sent the invite
        });
        
        alert("Personnel Authorized in pending_invites: " + email);
        
        // Clear inputs
        document.getElementById("inviteEmail").value = "";
        document.getElementById("inviteRobloxId").value = "";
      } catch (error) {
        console.error("Authorization Error:", error);
        alert("Error: " + error.message);
      }
    };

    document.getElementById("savePromoBtn").onclick = () => saveReq("requirements", "promoRankSelect", "pReq");
    document.getElementById("saveQuotaBtn").onclick = () => saveReq("quotas", "quotaRankSelect", "qReq");

    async function saveReq(coll, selectId, prefix) {
      const rank = document.getElementById(selectId).value;
      const data = {
        other: parseInt(document.getElementById(prefix+"Other").value) || 0,
        tryouts: parseInt(document.getElementById(prefix+"Try").value) || 0,
        bootcamps: parseInt(document.getElementById(prefix+"Boot").value) || 0,
        minutes: parseInt(document.getElementById(prefix+"Min").value) || 0
      };
      await setDoc(doc(db, coll, rank), data);
      alert("Saved to " + coll);
    }

    document.getElementById("resetAllWeeklyBtn").onclick = async () => {
      if (!confirm("RESET ALL WEEKLY QUOTAS? This is permanent.")) return;
      const snap = await getDocs(collection(db, "users"));
      const batch = writeBatch(db);
      snap.forEach(uDoc => {
        batch.update(uDoc.ref, { "quota.other": 0, "quota.tryouts": 0, "quota.bootcamps": 0, "quota.minutes": 0 });
      });
      await batch.commit();
      alert("All Quotas Reset.");
    };

    function loadUsers() {
      onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(uDoc => {
          const u = uDoc.data();
          const userRankIndex = ranks.indexOf(u.role);
          const isSuperiorOrEqual = userRankIndex >= currentAdminRankIndex;

          const div = document.createElement("div");
          div.className = "card";
          
          let roleOptions = ranks.map((r, idx) => {
            // Cannot promote anyone to a rank equal to or higher than admin's rank
            const disabled = idx >= currentAdminRankIndex ? "disabled" : "";
            const selected = r === u.role ? "selected" : "";
            return `<option value="${r}" ${selected} ${disabled}>${r}</option>`;
          }).join("");

          div.innerHTML = `
            <strong>${u.email}</strong> 
            <select class="role-select-mini" onchange="window.changeRank('${uDoc.id}', this.value)" ${isSuperiorOrEqual ? 'disabled' : ''}>
              ${roleOptions}
            </select><br>
            
            <div class="stats-block">
              <div>
                <label>Weekly Quota</label><br>
                T:${u.quota?.tryouts || 0} B:${u.quota?.bootcamps || 0} O:${u.quota?.other || 0} M:${u.quota?.minutes || 0}
              </div>
              <div>
                <label>Career Stats</label><br>
                Events: ${u.totalEvents || 0} | Mins: ${u.totalMinutes || 0}
              </div>
            </div>

            <div class="btn-row">
              <button class="reset-btn" onclick="window.resetData('${uDoc.id}', 'quota')" ${isSuperiorOrEqual ? 'disabled' : ''}>Reset Quota</button>
              <button class="reset-btn" onclick="window.resetData('${uDoc.id}', 'promo')" ${isSuperiorOrEqual ? 'disabled' : ''}>Reset Promo</button>
              <button class="reset-btn" style="background:#4a5568" onclick="window.resetData('${uDoc.id}', 'career')" ${isSuperiorOrEqual ? 'disabled' : ''}>Clear Career</button>
              <button class="fire-btn" onclick="window.fireUser('${uDoc.id}')" ${isSuperiorOrEqual ? 'disabled' : ''}>FIRE</button>
            </div>
          `;
          list.appendChild(div);
        });
      });
    }

    async function loadReformList() {
      const reformListDiv = document.getElementById("reformList");

      // 1. Listen for changes in the Quotas collection so we know the requirements
      onSnapshot(collection(db, "quotas"), (quotaSnap) => {
        const quotaMap = {};
        quotaSnap.forEach(doc => { quotaMap[doc.id] = doc.data(); });

        // 2. Listen for changes in Users
        onSnapshot(collection(db, "users"), (userSnap) => {
          reformListDiv.innerHTML = "";
          let count = 0;

          userSnap.forEach(uDoc => {
            const u = uDoc.data();
            const req = quotaMap[u.role];

            // If no quota is set for this rank, they aren't in reform
            if (!req) return;

            // 3. Check for any deficit
            const deficitTryouts = Math.max(0, (req.tryouts || 0) - (u.quota?.tryouts || 0));
            const deficitBootcamps = Math.max(0, (req.bootcamps || 0) - (u.quota?.bootcamps || 0));
            const deficitOther = Math.max(0, (req.other || 0) - (u.quota?.other || 0));
            const deficitMins = Math.max(0, (req.minutes || 0) - (u.quota?.minutes || 0));

            const isUnderQuota = deficitTryouts > 0 || deficitBootcamps > 0 || deficitOther > 0 || deficitMins > 0;

            if (isUnderQuota) {
              count++;
              const card = document.createElement("div");
              card.className = "card";
              card.style.borderLeftColor = "#dc3545"; // Red border for reform
              
              card.innerHTML = `
                <strong>${u.email}</strong> [${u.role}]<br>
                <span style="color: #fc8181; font-size: 11px;">
                  Missing: 
                  ${deficitTryouts > 0 ? `T:${deficitTryouts} ` : ''}
                  ${deficitBootcamps > 0 ? `B:${deficitBootcamps} ` : ''}
                  ${deficitOther > 0 ? `O:${deficitOther} ` : ''}
                  ${deficitMins > 0 ? `M:${deficitMins} ` : ''}
                </span>
              `;
              reformListDiv.appendChild(card);
            }
          });

          if (count === 0) {
            reformListDiv.innerHTML = "All personnel have met 100% quota.";
          }
        });
      });
    }

    window.changeRank = async (uid, newRank) => {
      if(!confirm(`Promote/Demote user to ${newRank}?`)) return;
      await updateDoc(doc(db, "users", uid), { role: newRank });
    };

    window.resetData = async (uid, type) => {
      if(!confirm(`Reset ${type} data?`)) return;
      const ref = doc(db, "users", uid);
      if(type === 'quota') await updateDoc(ref, { quota: { other:0, tryouts:0, bootcamps:0, minutes:0 }});
      if(type === 'promo') await updateDoc(ref, { promo: { other:0, tryouts:0, bootcamps:0, minutes:0 }});
      if(type === 'career') await updateDoc(ref, { totalEvents: 0, totalMinutes: 0 });
    };

    window.fireUser = async (uid) => {
      if(confirm("PERMANENTLY DELETE THIS ACCOUNT?")) await deleteDoc(doc(db, "users", uid));
    };

    // --- Event Type Logic ---

    document.getElementById("addTypeBtn").onclick = async () => {
      const name = document.getElementById("newTypeName").value.trim();
      if (name) {
        await addDoc(collection(db, "event_types"), { name });
        document.getElementById("newTypeName").value = "";
      }
    };

    function loadEventTypes() {
      onSnapshot(collection(db, "event_types"), (snap) => {
        const list = document.getElementById("typeList");
        list.innerHTML = "";
        snap.forEach(d => {
          const div = document.createElement("div");
          div.innerHTML = `<span>${d.data().name}</span> <button style="color:red; background:none; border:none; cursor:pointer;" onclick="window.delType('${d.id}')">[X]</button>`;
          list.appendChild(div);
        });
      });
    }
    window.delType = async (id) => { if(confirm("Delete type?")) await deleteDoc(doc(db, "event_types", id)); };

    // --- Approval Logic ---

    window.processLog = async (logId, approved) => {
      const logRef = doc(db, "event_pending", logId);
      const snap = await getDoc(logRef);
      if(!snap.exists()) return;
      const data = snap.data();

      if(approved) {
        const typeStr = data.type.toLowerCase();
        let field = "other";
        if (typeStr.includes("tryout")) field = "tryouts";
        else if (typeStr.includes("bootcamp")) field = "bootcamps";

        const batch = writeBatch(db);
        let emails = [data.hostEmail, ...(data.coHosts || []), ...(data.supervisors || [])];
        emails = [...new Set(emails.filter(e => e && e !== "None" && e !== "none"))];

        for (const email of emails) {
          const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", email.toLowerCase())));
          if (!uSnap.empty) {
            batch.update(uSnap.docs[0].ref, {
              totalEvents: increment(1),
              [`quota.${field}`]: increment(1),
              [`promo.${field}`]: increment(1)
            });
          }
        }
        batch.set(doc(collection(db, "event_history")), { ...data, approvedAt: new Date(), status: "Approved" });
        batch.delete(logRef);
        await batch.commit();
      } else {
        await deleteDoc(logRef);
      }
    };

    window.processMinutes = async (logId, approved) => {
      const logRef = doc(db, "minutes_pending", logId);
      const snap = await getDoc(logRef);
      if(approved && snap.exists()) {
        const data = snap.data();
        const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", data.hostEmail.toLowerCase())));
        if(!uSnap.empty) {
          await updateDoc(uSnap.docs[0].ref, {
            totalMinutes: increment(data.minutes),
            "quota.minutes": increment(data.minutes),
            "promo.minutes": increment(data.minutes)
          });
        }
        await setDoc(doc(collection(db, "event_history")), { ...data, approvedAt: new Date(), status: "Approved" });
      }
      await deleteDoc(logRef);
    };

    function loadPendingLogs() {
      onSnapshot(collection(db, "event_pending"), (snap) => {
        const q = document.getElementById("logQueue");
        q.innerHTML = snap.empty ? "No pending events." : "<h3>Pending Events</h3>";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>${data.type}</strong><br>Host: ${data.hostEmail}<br>
            <div class="btn-row">
              <button class="view-btn" onclick="window.viewProof('${d.id}', 'event_pending')">View Proof</button>
              <button class="approve-btn" onclick="window.processLog('${d.id}', true)">Approve</button>
              <button class="deny-btn" onclick="window.processLog('${d.id}', false)">Deny</button>
            </div>`;
          q.appendChild(card);
        });
      });
    }

    function loadPendingMinutes() {
      onSnapshot(collection(db, "minutes_pending"), (snap) => {
        const q = document.getElementById("minutesQueue");
        q.innerHTML = snap.empty ? "" : "<h3>Pending Minutes</h3>";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>${data.minutes} Mins</strong><br>User: ${data.hostEmail}<br>
            <div class="btn-row">
              <button class="approve-btn" onclick="window.processMinutes('${d.id}', true)">Approve</button>
              <button class="deny-btn" onclick="window.processMinutes('${d.id}', false)">Deny</button>
            </div>`;
          q.appendChild(card);
        });
      });
    }

    let historyCache = []; // Local storage for history to save on database costs

    function loadHistory() {
      const searchInput = document.getElementById("historySearch");
      
      // Real-time listener for the history collection
      onSnapshot(query(collection(db, "event_history"), orderBy("approvedAt", "desc")), (snap) => {
        historyCache = snap.docs;
        renderHistoryTable(historyCache, searchInput.value.toLowerCase());
      });

      // Search filters the local cache instead of re-querying the database
      searchInput.oninput = () => {
        renderHistoryTable(historyCache, searchInput.value.toLowerCase());
      };
    }

    function renderHistoryTable(docs, filter = "") {
      const tbody = document.getElementById("historyTableBody");
      tbody.innerHTML = "";

      const filteredDocs = docs.filter(d => {
        const data = d.data();
        return data.hostEmail?.toLowerCase().includes(filter) || 
               (data.type && data.type.toLowerCase().includes(filter));
      });

      if (filteredDocs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No history records found.</td></tr>`;
        return;
      }

      filteredDocs.forEach(d => {
        const data = d.data();
        // Convert Firebase timestamp to readable string
        const date = data.approvedAt?.toDate().toLocaleDateString() || "N/A";
        const time = data.approvedAt?.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) || "";
        
        // Display Logic
        const displayType = data.type || "Minutes Log";
        const detail = data.minutes ? `${data.minutes} Minutes` : (data.logCategory || "Event");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${date} <span style="color:#718096; font-size:10px;">${time}</span></td>
          <td style="font-family: monospace;">${data.hostEmail}</td>
          <td>${displayType}</td>
          <td>${detail}</td>
          <td><span class="status-badge badge-approved">${data.status || 'Approved'}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.viewProof = async (logId, coll) => {
      const chunks = await getDocs(query(collection(db, `${coll}/${logId}/chunks`), orderBy("index")));
      if(chunks.empty) return alert("No proof found for this log.");
      let b64 = "";
      chunks.forEach(c => b64 += c.data().data);
      const win = window.open("");
      win.document.write(`<html><body style="margin:0; background:#000;"><img src="data:image/png;base64,${b64}" style="width:100%"></body></html>`);
    };
  </script>
</body>
</html>