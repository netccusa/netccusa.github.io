<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #001226; color: white; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 1000px; display: flex; justify-content: flex-start; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; text-transform: uppercase; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; }
    .admin-container { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 8px; border-top: 3px solid #e2b13c; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
    h2 { text-transform: uppercase; letter-spacing: 2px; color: #e2b13c; font-size: 18px; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #334e68; background: #001e3c; color: white; box-sizing: border-box; }
    .action-btn { background: #e2b13c; color: #001226; font-weight: bold; cursor: pointer; border: none; }
    .user-list-container, .log-queue { max-height: 400px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
    .card { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-left: 3px solid #e2b13c; font-size: 13px; }
    .approve-btn { background: #28a745; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    .deny-btn { background: #dc3545; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; }
    .view-btn { background: #334e68; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    select.role-select { width: auto; padding: 2px; font-size: 11px; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="nav-links"><a href="dashboard.html" class="btn-small">← Dashboard</a></div>

  <div class="admin-grid">
    <div>
      <div class="admin-container">
        <h2>Authorize Access</h2>
        <input type="email" id="inviteEmail" placeholder="Email">
        <input type="number" id="inviteRobloxId" placeholder="Roblox ID">
        <button class="action-btn" id="sendInviteBtn">Authorize</button>
      </div>
      <div class="admin-container">
        <h2>Personnel Management</h2>
        <div id="userList" class="user-list-container">Loading...</div>
      </div>
    </div>

    <div>
      <div class="admin-container" id="typeManager" style="display:none;">
        <h2>Event Type Management</h2>
        <input type="text" id="newTypeName" placeholder="e.g. Basic Combat Training">
        <button class="action-btn" id="addTypeBtn">Add Event Type</button>
        <div id="typeList" style="margin-top:10px; font-size:12px;"></div>
      </div>

      <div class="admin-container">
        <h2>Awaiting Approval</h2>
        <div id="logQueue" class="log-queue">No pending logs.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, 
      updateDoc, deleteDoc, addDoc, getDocs, writeBatch, increment,
      query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const roles = ["User", "HICOM", "Director", "Headquarters", "SECNAV", "Admin"];
    let myRole = "user";

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");
      const userSnap = await getDoc(doc(db, "users", user.uid));
      myRole = (userSnap.data()?.role || "user").toLowerCase();
      
      if (!["admin", "director", "hicom", "headquarters", "secnav"].includes(myRole)) window.location.replace("dashboard.html");
      if (["admin", "director", "headquarters", "secnav"].includes(myRole)) document.getElementById("typeManager").style.display = "block";

      loadUsers();
      loadEventTypes();
      loadPendingLogs();
    });

    // 1. Manage Event Types
    document.getElementById("addTypeBtn").onclick = async () => {
      const name = document.getElementById("newTypeName").value.trim();
      if (!name) return;
      await addDoc(collection(db, "event_types"), { name });
      document.getElementById("newTypeName").value = "";
    };

    function loadEventTypes() {
      onSnapshot(collection(db, "event_types"), (snap) => {
        const list = document.getElementById("typeList");
        list.innerHTML = "";
        snap.forEach(d => {
          const item = document.createElement("div");
          item.style.marginBottom = "5px";
          item.innerHTML = `• ${d.data().name} <button style="width:auto; padding:2px 8px; background:red; border:none; cursor:pointer;" onclick="window.confirmDeleteType('${d.id}', '${d.data().name}')">Delete</button>`;
          list.appendChild(item);
        });
      });
    }

    window.confirmDeleteType = (id, name) => {
        if(confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
            deleteDoc(doc(db, "event_types", id));
        }
    };

    // 2. Pending Logs & Image View
    function loadPendingLogs() {
      onSnapshot(collection(db, "event_pending"), (snap) => {
        const queue = document.getElementById("logQueue");
        queue.innerHTML = snap.empty ? "No pending logs." : "";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>Type:</strong> ${data.type}<br>
            <strong>Host:</strong> ${data.hostEmail}<br>
            <strong>Attendees:</strong> ${data.attendees} | <strong>Passers:</strong> ${data.passers}<br>
            <button class="view-btn" onclick="window.viewProof('${d.id}')">View Proof</button>
            <button class="approve-btn" onclick="window.processLog('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processLog('${d.id}', false)">Deny</button>
          `;
          queue.appendChild(card);
        });
      });
    }

    window.viewProof = async (logId) => {
        const chunksSnap = await getDocs(query(collection(db, `event_pending/${logId}/chunks`), orderBy("index")));
        let fullBase64 = "";
        chunksSnap.forEach(chunk => fullBase64 += chunk.data().data);
        
        const win = window.open("");
        win.document.write(`<img src="data:image/png;base64,${fullBase64}" style="max-width:100%;">`);
    };

    window.processLog = async (logId, approved) => {
      try {
        const logRef = doc(db, "event_pending", logId);
        const logSnap = await getDoc(logRef);
        if(!logSnap.exists()) return;
        const data = logSnap.data();

        if (approved) {
          const q = query(collection(db, "users"), where("email", "==", data.hostEmail));
          const userQuery = await getDocs(q);
          const batch = writeBatch(db);
          if(!userQuery.empty) batch.update(userQuery.docs[0].ref, { totalEvents: increment(1) });
          
          const historyRef = doc(collection(db, "event_history"));
          batch.set(historyRef, { ...data, approvedAt: new Date(), approvedBy: auth.currentUser.email });
          batch.delete(logRef);
          await batch.commit();
        } else {
          await deleteDoc(logRef);
        }
        alert(approved ? "Log Approved" : "Log Denied");
      } catch (e) { alert("Error: " + e.message); }
    };

    // 3. User & Role Management
    async function loadUsers() {
      onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(uDoc => {
          const u = uDoc.data();
          const div = document.createElement("div");
          div.className = "card";
          
          let roleOptions = roles.map(r => `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`).join('');
          
          div.innerHTML = `
            <strong>${u.email}</strong><br>
            Events: ${u.totalEvents || 0}
            <select class="role-select" onchange="window.updateRole('${uDoc.id}', this.value)">
                ${roleOptions}
            </select>
          `;
          list.appendChild(div);
        });
      });
    }

    window.updateRole = async (uid, newRole) => {
        await updateDoc(doc(db, "users", uid), { role: newRole });
        alert("Role updated to " + newRole);
    };

    document.getElementById("sendInviteBtn").onclick = async () => {
      const email = document.getElementById("inviteEmail").value.toLowerCase().trim();
      const rid = document.getElementById("inviteRobloxId").value;
      if(!email) return alert("Email required");
      await setDoc(doc(db, "pending_invites", email), { robloxUserId: rid, invitedAt: new Date(), invitedBy: auth.currentUser.email });
      alert("Authorized");
    };
  </script>
</body>
</html>