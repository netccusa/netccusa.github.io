<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #001226; color: white; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 1000px; display: flex; justify-content: flex-start; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; text-transform: uppercase; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; }
    .admin-container { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 8px; border-top: 3px solid #e2b13c; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
    h2 { text-transform: uppercase; letter-spacing: 2px; color: #e2b13c; font-size: 18px; margin-top: 0; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #334e68; background: #001e3c; color: white; box-sizing: border-box; }
    .action-btn { background: #e2b13c; color: #001226; font-weight: bold; cursor: pointer; border: none; }
    .user-list-container { max-height: 600px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
    .log-queue { max-height: 300px; overflow-y: auto; }
    .card { background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 10px; border-left: 3px solid #e2b13c; font-size: 13px; }
    .btn-row { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
    .approve-btn { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; width: auto; border-radius: 3px; }
    .deny-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; width: auto; border-radius: 3px; }
    .reset-btn { background: #6b46c1; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; width: auto; border-radius: 3px; }
    .fire-btn { background: #e53e3e; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; width: auto; border-radius: 3px; }
    .req-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
    .req-grid input { padding: 5px; font-size: 11px; }
    label { font-size: 10px; color: #718096; text-transform: uppercase; }
  </style>
</head>
<body>
  <div class="nav-links"><a href="dashboard.html" class="btn-small">‚Üê Dashboard</a></div>

  <div class="admin-grid">
    <div>
      <div class="admin-container">
        <h2>Personnel Management</h2>
        <div id="userList" class="user-list-container">Loading personnel...</div>
      </div>
    </div>

    <div>
      <div class="admin-container">
        <h2>Promotion Requirements</h2>
        <select id="promoRankSelect"></select>
        <div class="req-grid">
          <div><label>Other</label><input type="number" id="pReqOther" value="0"></div>
          <div><label>Tryouts</label><input type="number" id="pReqTry" value="0"></div>
          <div><label>Bootcamps</label><input type="number" id="pReqBoot" value="0"></div>
          <div><label>Mins</label><input type="number" id="pReqMin" value="0"></div>
        </div>
        <button class="action-btn" id="savePromoBtn" style="margin-top:10px">Save Promotion Req</button>
      </div>

      <div class="admin-container" style="border-top-color: #38b2ac;">
        <h2 style="color: #38b2ac;">Weekly Quota Requirements</h2>
        <select id="quotaRankSelect"></select>
        <div class="req-grid">
          <div><label>Other</label><input type="number" id="qReqOther" value="0"></div>
          <div><label>Tryouts</label><input type="number" id="qReqTry" value="0"></div>
          <div><label>Bootcamps</label><input type="number" id="qReqBoot" value="0"></div>
          <div><label>Mins</label><input type="number" id="qReqMin" value="0"></div>
        </div>
        <button class="action-btn" id="saveQuotaBtn" style="margin-top:10px; background: #38b2ac;">Save Weekly Quota</button>
      </div>

      <div class="admin-container">
        <h2>Awaiting Approval</h2>
        <div id="logQueue" class="log-queue">No pending logs.</div>
        <div id="minutesQueue" class="log-queue" style="margin-top:15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, 
      updateDoc, deleteDoc, addDoc, getDocs, writeBatch, increment,
      query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ranks = [
      "Probationary Navy Instructor", "Junior Navy Instructor I", "Junior Navy Instructor II",
      "Navy Instructor I", "Navy Instructor II", "Navy Instructor III", "Senior Navy Instructor",
      "Head Navy Instructor I", "Head Navy Instructor II", "Deputy Chief Navy Instructor I",
      "Deputy Chief Navy Instructor II", "Chief Navy Instructor", "HICOM", "Deputy Director",
      "Director", "Headquarters", "SECNAV", "Commander in Chief", "Admin"
    ];

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");
      const userSnap = await getDoc(doc(db, "users", user.uid));
      const myRank = userSnap.data()?.role?.toLowerCase() || "";
      const staff = ["hicom", "deputy director", "director", "headquarters", "secnav", "commander in chief", "admin"];
      if (!staff.includes(myRank)) return window.location.replace("dashboard.html");

      initDropdowns();
      loadUsers();
      loadPendingLogs();
      loadPendingMinutes();
    });

    function initDropdowns() {
      const pSel = document.getElementById("promoRankSelect");
      const qSel = document.getElementById("quotaRankSelect");
      ranks.forEach(r => {
        let o1 = document.createElement("option"); o1.value = r; o1.textContent = r; pSel.appendChild(o1);
        let o2 = document.createElement("option"); o2.value = r; o2.textContent = r; qSel.appendChild(o2);
      });
    }

    // Save Handlers
    document.getElementById("savePromoBtn").onclick = () => saveReq("requirements", "promoRankSelect", "pReq");
    document.getElementById("saveQuotaBtn").onclick = () => saveReq("quotas", "quotaRankSelect", "qReq");

    async function saveReq(coll, selectId, prefix) {
      const rank = document.getElementById(selectId).value;
      const data = {
        other: parseInt(document.getElementById(prefix+"Other").value) || 0,
        tryouts: parseInt(document.getElementById(prefix+"Try").value) || 0,
        bootcamps: parseInt(document.getElementById(prefix+"Boot").value) || 0,
        minutes: parseInt(document.getElementById(prefix+"Min").value) || 0
      };
      await setDoc(doc(db, coll, rank), data);
      alert("Saved to " + coll);
    }

    function loadUsers() {
      onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(uDoc => {
          const u = uDoc.data();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <strong>${u.email}</strong> [${u.role || 'User'}]<br>
            <label>Career:</label> ${u.totalEvents || 0} Events | ${u.totalMinutes || 0} Mins<br>
            <div class="btn-row">
              <button class="reset-btn" onclick="window.resetData('${uDoc.id}', 'quota')">Reset Quota</button>
              <button class="reset-btn" onclick="window.resetData('${uDoc.id}', 'promo')">Reset Promo</button>
              <button class="reset-btn" style="background:#4a5568" onclick="window.resetData('${uDoc.id}', 'career')">Clear Career</button>
              <button class="fire-btn" onclick="window.fireUser('${uDoc.id}')">FIRE</button>
            </div>
          `;
          list.appendChild(div);
        });
      });
    }

    window.resetData = async (uid, type) => {
      if(!confirm(`Reset ${type} data?`)) return;
      const ref = doc(db, "users", uid);
      if(type === 'quota') await updateDoc(ref, { quota: { other:0, tryouts:0, bootcamps:0, minutes:0 }});
      if(type === 'promo') await updateDoc(ref, { promo: { other:0, tryouts:0, bootcamps:0, minutes:0 }});
      if(type === 'career') await updateDoc(ref, { totalEvents: 0, totalMinutes: 0 });
    };

    window.fireUser = async (uid) => {
      if(confirm("PERMANENTLY DELETE THIS ACCOUNT?")) await deleteDoc(doc(db, "users", uid));
    };

    // Approval Logics
    window.processLog = async (logId, approved) => {
      const logRef = doc(db, "event_pending", logId);
      const snap = await getDoc(logRef);
      if(approved && snap.exists()) {
        const data = snap.data();
        const field = data.type.toLowerCase().includes("tryout") ? "tryouts" : data.type.toLowerCase().includes("bootcamp") ? "bootcamps" : "other";
        const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", data.hostEmail)));
        if(!uSnap.empty) {
          await updateDoc(uSnap.docs[0].ref, {
            totalEvents: increment(1),
            [`quota.${field}`]: increment(1),
            [`promo.${field}`]: increment(1)
          });
        }
        await setDoc(doc(collection(db, "event_history")), { ...data, approvedAt: new Date() });
      }
      await deleteDoc(logRef);
    };

    window.processMinutes = async (logId, approved) => {
      const logRef = doc(db, "minutes_pending", logId);
      const snap = await getDoc(logRef);
      if(approved && snap.exists()) {
        const data = snap.data();
        const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", data.hostEmail)));
        if(!uSnap.empty) {
          await updateDoc(uSnap.docs[0].ref, {
            totalMinutes: increment(data.minutes),
            "quota.minutes": increment(data.minutes),
            "promo.minutes": increment(data.minutes)
          });
        }
      }
      await deleteDoc(logRef);
    };

    function loadPendingLogs() {
      onSnapshot(collection(db, "event_pending"), (snap) => {
        const q = document.getElementById("logQueue");
        q.innerHTML = snap.empty ? "No pending events." : "<h3>Events</h3>";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `${data.type} - ${data.hostEmail} <br>
            <button class="approve-btn" onclick="window.processLog('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processLog('${d.id}', false)">Deny</button>`;
          q.appendChild(card);
        });
      });
    }

    function loadPendingMinutes() {
      onSnapshot(collection(db, "minutes_pending"), (snap) => {
        const q = document.getElementById("minutesQueue");
        q.innerHTML = snap.empty ? "" : "<h3>Minutes</h3>";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `${data.minutes} Mins - ${data.hostEmail} <br>
            <button class="approve-btn" onclick="window.processMinutes('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processMinutes('${d.id}', false)">Deny</button>`;
          q.appendChild(card);
        });
      });
    }
  </script>
</body>
</html>