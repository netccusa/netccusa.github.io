<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #001226; color: white; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 1000px; display: flex; justify-content: flex-start; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; text-transform: uppercase; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; }
    .admin-container { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 8px; border-top: 3px solid #e2b13c; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
    h2 { text-transform: uppercase; letter-spacing: 2px; color: #e2b13c; font-size: 18px; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #334e68; background: #001e3c; color: white; box-sizing: border-box; }
    .action-btn { background: #e2b13c; color: #001226; font-weight: bold; cursor: pointer; border: none; }
    .user-list-container, .log-queue { max-height: 500px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
    .card { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-left: 3px solid #e2b13c; font-size: 13px; }
    .approve-btn { background: #28a745; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    .deny-btn { background: #dc3545; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; }
    .view-btn { background: #334e68; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    .reset-btn { background: #6b46c1; color: white; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-right: 4px; margin-top: 5px; border-radius: 3px; }
    .fire-btn { background: #e53e3e; color: white; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; border-radius: 3px; }
    select.role-select { width: auto; padding: 2px; font-size: 11px; margin-left: 10px; background: #001226; }
    .req-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
    .req-grid input { padding: 5px; font-size: 11px; }
  </style>
</head>
<body>
  <div class="nav-links"><a href="dashboard.html" class="btn-small">← Dashboard</a></div>

  <div class="admin-grid">
    <div>
      <div class="admin-container">
        <h2>Authorize Access</h2>
        <input type="email" id="inviteEmail" placeholder="Email">
        <input type="number" id="inviteRobloxId" placeholder="Roblox ID">
        <button class="action-btn" id="sendInviteBtn">Authorize</button>
      </div>

      <div class="admin-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Personnel Management</h2>
            <button class="reset-btn" id="resetAllWeeklyBtn" style="background: #e53e3e; padding: 5px 10px;">RESET ALL QUOTA</button>
        </div>
        <div id="userList" class="user-list-container">Loading personnel...</div>
      </div>
    </div>

    <div>
      <div class="admin-container" id="rankManager">
        <h2>Rank Requirements Manager</h2>
        <select id="reqRankSelect"></select>
        <div class="req-grid">
          <div><label style="font-size:10px">Other</label><input type="number" id="reqOther" value="0"></div>
          <div><label style="font-size:10px">Tryouts</label><input type="number" id="reqTryouts" value="0"></div>
          <div><label style="font-size:10px">Bootcamps</label><input type="number" id="reqBootcamps" value="0"></div>
          <div><label style="font-size:10px">Minutes</label><input type="number" id="reqMins" value="0"></div>
        </div>
        <button class="action-btn" id="saveReqBtn" style="margin-top:10px">Save Requirements</button>
      </div>

      <div class="admin-container" id="typeManager">
        <h2>Event Type Management</h2>
        <input type="text" id="newTypeName" placeholder="e.g. Basic Combat Training">
        <button class="action-btn" id="addTypeBtn">Add Event Type</button>
        <div id="typeList" style="margin-top:10px; font-size:12px;"></div>
      </div>

      <div class="admin-container">
        <h2>Awaiting Approval (Events)</h2>
        <div id="logQueue" class="log-queue">No pending event logs.</div>
      </div>

      <div class="admin-container" style="border-top-color: #9f7aea;">
        <h2 style="color: #9f7aea;">Awaiting Approval (Minutes)</h2>
        <div id="minutesQueue" class="log-queue">No pending minutes logs.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, 
      updateDoc, deleteDoc, addDoc, getDocs, writeBatch, increment,
      query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ranks = [
      "Probationary Navy Instructor", "Junior Navy Instructor I", "Junior Navy Instructor II",
      "Navy Instructor I", "Navy Instructor II", "Navy Instructor III", "Senior Navy Instructor",
      "Head Navy Instructor I", "Head Navy Instructor II", "Deputy Chief Navy Instructor I",
      "Deputy Chief Navy Instructor II", "Chief Navy Instructor", "HICOM", "Deputy Director",
      "Director", "Headquarters", "SECNAV", "Commander in Chief", "Admin"
    ];

    let currentUserUid = "";

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");
      currentUserUid = user.uid;
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (!userSnap.exists()) return window.location.replace("dashboard.html");
      
      const myRank = userSnap.data().role || "User";
      const staffRanks = ["hicom", "deputy director", "director", "headquarters", "secnav", "commander in chief", "admin"];
      if (!staffRanks.includes(myRank.toLowerCase())) return window.location.replace("dashboard.html");

      initRankDropdown();
      loadUsers();
      loadEventTypes();
      loadPendingLogs();
      loadPendingMinutes();
    });

    function initRankDropdown() {
      const sel = document.getElementById("reqRankSelect");
      ranks.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r; opt.textContent = r;
        sel.appendChild(opt);
      });
    }

    document.getElementById("saveReqBtn").onclick = async () => {
      const rank = document.getElementById("reqRankSelect").value;
      const data = {
        other: parseInt(document.getElementById("reqOther").value) || 0,
        tryouts: parseInt(document.getElementById("reqTryouts").value) || 0,
        bootcamps: parseInt(document.getElementById("reqBootcamps").value) || 0,
        minutes: parseInt(document.getElementById("reqMins").value) || 0
      };
      try {
        await setDoc(doc(db, "requirements", rank), data);
        alert("Saved requirements for " + rank);
      } catch (e) { alert("Error: " + e.message); }
    };

    document.getElementById("resetAllWeeklyBtn").onclick = async () => {
      if (!confirm("RESET ALL QUOTAS? This affects every user.")) return;
      const snap = await getDocs(collection(db, "users"));
      const batch = writeBatch(db);
      snap.forEach(uDoc => {
        batch.update(uDoc.ref, { 
          "quota.other": 0, "quota.tryouts": 0, "quota.bootcamps": 0, "quota.minutes": 0 
        });
      });
      await batch.commit();
      alert("All Quotas Reset.");
    };

    async function loadUsers() {
      onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(uDoc => {
          const u = uDoc.data();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <strong>${u.email}</strong> [${u.role || 'User'}]<br>
            Quota (T/B/O/M): ${(u.quota?.tryouts || 0)}/${(u.quota?.bootcamps || 0)}/${(u.quota?.other || 0)}/${(u.quota?.minutes || 0)}<br>
            <button class="reset-btn" onclick="window.resetIndividual('${uDoc.id}', 'quota')">Reset Quota</button>
            <button class="reset-btn" onclick="window.resetIndividual('${uDoc.id}', 'promo')">Reset Promo</button>
          `;
          list.appendChild(div);
        });
      });
    }

    window.resetIndividual = async (uid, type) => {
      const updates = {};
      if (type === 'quota') updates.quota = { other: 0, tryouts: 0, bootcamps: 0, minutes: 0 };
      if (type === 'promo') updates.promo = { other: 0, tryouts: 0, bootcamps: 0, minutes: 0 };
      await updateDoc(doc(db, "users", uid), updates);
    };

    document.getElementById("addTypeBtn").onclick = async () => {
      const name = document.getElementById("newTypeName").value.trim();
      if (name) await addDoc(collection(db, "event_types"), { name });
    };

    function loadEventTypes() {
      onSnapshot(collection(db, "event_types"), (snap) => {
        const list = document.getElementById("typeList");
        list.innerHTML = "";
        snap.forEach(d => {
          const div = document.createElement("div");
          div.innerHTML = `• ${d.data().name} <button style="color:red; background:none; border:none; cursor:pointer;" onclick="window.delType('${d.id}')">[X]</button>`;
          list.appendChild(div);
        });
      });
    }

    window.delType = async (id) => { if(confirm("Delete type?")) await deleteDoc(doc(db, "event_types", id)); };

    function loadPendingLogs() {
      onSnapshot(collection(db, "event_pending"), (snap) => {
        const queue = document.getElementById("logQueue");
        queue.innerHTML = snap.empty ? "No pending logs." : "";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>Type:</strong> ${data.type}<br><strong>Host:</strong> ${data.hostEmail}<br>
            <button class="view-btn" onclick="window.viewProof('${d.id}', 'event_pending')">Proof</button>
            <button class="approve-btn" onclick="window.processLog('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processLog('${d.id}', false)">Deny</button>
          `;
          queue.appendChild(card);
        });
      });
    }

    function loadPendingMinutes() {
      onSnapshot(collection(db, "minutes_pending"), (snap) => {
        const queue = document.getElementById("minutesQueue");
        queue.innerHTML = snap.empty ? "No pending minutes." : "";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<strong>Mins:</strong> ${data.minutes}<br><strong>User:</strong> ${data.hostEmail}<br>
            <button class="approve-btn" onclick="window.processMinutes('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processMinutes('${d.id}', false)">Deny</button>`;
          queue.appendChild(card);
        });
      });
    }

    window.processLog = async (logId, approved) => {
      if(!confirm("Confirm?")) return;
      const logRef = doc(db, "event_pending", logId);
      const snap = await getDoc(logRef);
      if(!snap.exists()) return;
      const data = snap.data();

      if(approved) {
        const typeStr = data.type.toLowerCase();
        let field = "other";
        if (typeStr.includes("tryout")) field = "tryouts";
        else if (typeStr.includes("bootcamp")) field = "bootcamps";

        const batch = writeBatch(db);
        let emails = [data.hostEmail, ...(data.coHosts || []), ...(data.supervisors || [])];
        emails = [...new Set(emails.filter(e => e && e !== "None"))];

        for (const email of emails) {
          const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", email)));
          if (!uSnap.empty) {
            batch.update(uSnap.docs[0].ref, {
              totalEvents: increment(1),
              [`quota.${field}`]: increment(1),
              [`promo.${field}`]: increment(1)
            });
          }
        }
        batch.set(doc(collection(db, "event_history")), { ...data, approvedAt: new Date() });
        batch.delete(logRef);
        await batch.commit();
      } else { await deleteDoc(logRef); }
      alert("Done");
    };

    window.processMinutes = async (logId, approved) => {
      const logRef = doc(db, "minutes_pending", logId);
      const snap = await getDoc(logRef);
      if(approved && snap.exists()) {
        const data = snap.data();
        const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", data.hostEmail)));
        if(!uSnap.empty) {
          await updateDoc(uSnap.docs[0].ref, {
            totalMinutes: increment(data.minutes),
            "quota.minutes": increment(data.minutes),
            "promo.minutes": increment(data.minutes)
          });
        }
        await setDoc(doc(collection(db, "event_history")), { ...data, approvedAt: new Date() });
        await deleteDoc(logRef);
      } else { await deleteDoc(logRef); }
      alert("Done");
    };

    window.viewProof = async (logId, coll) => {
      const chunks = await getDocs(query(collection(db, `${coll}/${logId}/chunks`), orderBy("index")));
      let b64 = "";
      chunks.forEach(c => b64 += c.data().data);
      window.open("").document.write(`<img src="data:image/png;base64,${b64}" style="width:100%">`);
    };
  </script>
</body>
</html>