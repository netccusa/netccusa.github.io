<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | NETC Portal</title>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    body { 
      font-family: 'Segoe UI', sans-serif; 
      padding: 20px; 
      text-align: center; 
      background: linear-gradient(rgba(0, 18, 38, 0.85), rgba(0, 18, 38, 0.85)), url('bckgr2.png'); 
      background-size: cover; 
      background-position: center; 
      background-attachment: fixed; 
      color: white; 
      min-height: 100vh; 
      margin: 0; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }

    .nav-links { width: 100%; max-width: 1000px; display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
    
    .btn-small { 
      padding: 8px 16px; 
      background-color: rgba(255, 255, 255, 0.1); 
      color: white; 
      border: 1px solid #e2b13c; 
      border-radius: 4px; 
      cursor: pointer; 
      text-decoration: none; 
      font-size: 12px; 
      text-transform: uppercase; 
      transition: 0.3s; 
    }
    .btn-small:hover { background-color: #e2b13c; color: #001226; }

    .center-logo { display: block; margin: 20px auto; width: 100px; }

    .dashboard-container { 
      background: rgba(0, 30, 60, 0.6); 
      backdrop-filter: blur(10px); 
      padding: 30px; 
      border-radius: 8px; 
      border-top: 3px solid #e2b13c; 
      width: 100%; 
      max-width: 600px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
      animation: fadeIn 1s ease-out;
    }

    h1 { color: #e2b13c; margin: 0; text-transform: uppercase; font-size: 24px; letter-spacing: 2px; }
    #roleDisplay { color: #e2b13c; margin: 5px 0 20px 0; font-size: 18px; font-weight: bold; text-transform: uppercase; }
    
    .stats-header { 
      font-size: 11px; 
      color: #718096; 
      text-transform: uppercase; 
      margin: 25px 0 10px 0; 
      text-align: left; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
      padding-bottom: 5px; 
      letter-spacing: 1px;
    }
    
    /* Stats Grids */
    .stat-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-box { 
      background: rgba(255,255,255,0.03); 
      padding: 15px; 
      border-radius: 6px; 
      border: 1px solid rgba(255,255,255,0.05); 
    }
    .stat-box span { display: block; font-size: 22px; font-weight: bold; color: #e2b13c; }
    .stat-box label { font-size: 9px; color: #718096; text-transform: uppercase; }

    /* Progress Bars */
    .progress-section { margin-bottom: 12px; text-align: left; }
    .progress-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; }
    .progress-bar-bg { background: rgba(255,255,255,0.05); height: 8px; border-radius: 4px; border: 1px solid rgba(226, 177, 60, 0.2); overflow: hidden; }
    .progress-fill { background: #e2b13c; height: 100%; width: 0%; transition: width 0.8s; }
    .fill-mins { background: #e2b13c; }
    .fill-total { background: #28a745; }

    /* Action Buttons */
    .btn-group { display: flex; gap: 10px; flex-direction: column; margin-top: 25px; }
    .action-btn { 
      background: #e2b13c; 
      color: #001226; 
      padding: 12px; 
      border: none; 
      border-radius: 4px; 
      font-weight: bold; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.3s;
    }
    .action-btn:hover { opacity: 0.9; transform: scale(1.02); }
    /* The new Red Logout Button style */
    .logout-action-btn { 
      background: #ff4d4d; 
      color: white; 
      padding: 12px; 
      border: none; 
      border-radius: 4px; 
      font-weight: bold; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.3s;
      cursor: pointer;
      width: 100%;
      margin-top: 25px;
    }
    .logout-action-btn:hover { opacity: 0.9; transform: scale(1.02); }

    /* The new Small Resign link style */
    #resignBtn { 
      margin-top: 20px; 
      background: none; 
      border: none;
      color: #718096; 
      cursor: pointer; 
      text-decoration: underline; 
      font-size: 11px; 
      width: 100%;
      transition: 0.3s;
      text-transform: uppercase;
    }
    #resignBtn:hover { color: #ff4d4d; }
  </style>
</head>
<body>

  <div class="nav-links">
    <a href="admin.html" id="adminLink" class="btn-small" style="display: none;">Admin Panel</a>
  </div>

  <img src="netc.png" class="center-logo" alt="NETC Logo">

  <div class="dashboard-container">
    <h1>NETC Portal</h1>
    <div id="roleDisplay">Loading...</div>

    <div class="stats-header">Career Statistics</div>
    <div class="stat-box-grid">
      <div class="stat-box"><span id="cEvents">0</span><label>Lifetime Events</label></div>
      <div class="stat-box"><span id="cMins">0</span><label>Lifetime Minutes</label></div>
    </div>

    <div class="stats-header">Divisions Weekly Statistics</div>
    <div class="stat-box-grid">
      <div class="stat-box"><span id="gEvents">0</span><label>Total Events</label></div>
      <div class="stat-box"><span id="gMins" style="color: #e2b13c;">0</span><label>Total Minutes</label></div>
    </div>

    <div class="stats-header">Weekly Quota Progress</div>
    <div id="quotaContainer"></div>
    <div class="progress-section" style="margin-top: 15px;">
      <div class="progress-label"><span>Total Promotion Progress</span><span id="qTotalTxt">0%</span></div>
      <div class="progress-bar-bg"><div id="qTotalBar" class="progress-fill fill-total"></div></div>
    </div>

    <div class="stats-header">Promotion Progress</div>
    <div id="promoContainer"></div>
    <div class="progress-section" style="margin-top: 15px;">
        <div class="progress-label"><span>Total Promotion Progress</span><span id="pTotalTxt">0%</span></div>
        <div class="progress-bar-bg"><div id="pTotalBar" class="progress-fill fill-total"></div></div>
    </div>

    <div class="btn-group">
      <a href="eventlogs.html" class="action-btn">Submit Event Log</a>
      <a href="minuteslogs.html" class="action-btn" style="background: #9f7aea; color: white;">Submit Minutes Log</a>
    </div>

    <button id="logoutBtn" class="logout-action-btn">Logout</button>
    <button id="resignBtn">Resign (Delete Account)</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");

      onSnapshot(doc(db, "users", user.uid), async (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        const rank = data.role || "User";
        
        document.getElementById("roleDisplay").textContent = rank;
        document.getElementById("cEvents").textContent = data.totalEvents || 0;
        document.getElementById("cMins").textContent = data.totalMinutes || 0;

        // Admin Access
        const staff = ["hicom", "deputy director", "director", "headquarters", "secnav", "commander in chief", "admin"];
        if (staff.includes(rank.toLowerCase())) document.getElementById("adminLink").style.display = "block";

        // Requirements Fetching
        const qReqSnap = await getDoc(doc(db, "quotas", rank));
        const pReqSnap = await getDoc(doc(db, "requirements", rank));
        
        const qReq = qReqSnap.exists() ? qReqSnap.data() : { tryouts: 0, bootcamps: 0, other: 0, minutes: 0 };
        const pReq = pReqSnap.exists() ? pReqSnap.data() : { tryouts: 0, bootcamps: 0, other: 0, minutes: 0 };

        const quotaAvg = renderBars("quotaContainer", data.quota, qReq, true);
        const promoAvg = renderBars("promoContainer", data.promo, pReq, true);

        // Update the Total Progress Bar
        document.getElementById("qTotalBar").style.width = quotaAvg + "%";
        document.getElementById("qTotalTxt").textContent = quotaAvg + "%";
        document.getElementById("pTotalBar").style.width = promoAvg + "%";
        document.getElementById("pTotalTxt").textContent = promoAvg + "%";
      });

      // Global/Division Statistics
      onSnapshot(collection(db, "users"), (snap) => {
        let e = 0, m = 0;
        snap.forEach(d => {
          const u = d.data();
          e += (u.quota?.tryouts || 0) + (u.quota?.bootcamps || 0) + (u.quota?.other || 0);
          m += (u.quota?.minutes || 0);
        });
        document.getElementById("gEvents").textContent = e;
        document.getElementById("gMins").textContent = m;
      });

      document.getElementById("resignBtn").onclick = async () => {
        if(confirm("Are you sure you want to resign? This deletes your account forever.")){
          try {
            await deleteDoc(doc(db, "users", user.uid));
            await deleteUser(user);
            window.location.replace("index.html");
          } catch (err) {
            alert("Error: Please re-login before deleting your account for security reasons.");
          }
        }
      };
    });

    function renderBars(containerId, current, required, calculateAvg) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";
      const fields = ["tryouts", "bootcamps", "other", "minutes"];
      let totalPerc = 0;

      fields.forEach(f => {
        const cur = current?.[f] || 0;
        const req = required?.[f] || 0;
        const perc = req <= 0 ? 100 : Math.min((cur/req)*100, 100);
        totalPerc += perc;

        const colorClass = f === "minutes" ? "fill-mins" : "";
        
        cont.innerHTML += `
          <div class="progress-section">
            <div class="progress-label"><span>${f}</span><span>${cur}/${req}</span></div>
            <div class="progress-bar-bg">
                <div class="progress-fill ${colorClass}" style="width:${perc}%"></div>
            </div>
          </div>`;
      });

      return Math.floor(totalPerc / fields.length);
    }

    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => window.location.replace("index.html"));
  </script>
</body>
</html>