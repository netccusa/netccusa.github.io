<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #001226; color: white; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 1000px; display: flex; justify-content: flex-start; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; text-transform: uppercase; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; }
    .admin-container { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 8px; border-top: 3px solid #e2b13c; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
    h2 { text-transform: uppercase; letter-spacing: 2px; color: #e2b13c; font-size: 18px; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #334e68; background: #001e3c; color: white; box-sizing: border-box; }
    .action-btn { background: #e2b13c; color: #001226; font-weight: bold; cursor: pointer; border: none; }
    .user-list-container, .log-queue { max-height: 500px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
    .card { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-left: 3px solid #e2b13c; font-size: 13px; }
    .approve-btn { background: #28a745; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    .deny-btn { background: #dc3545; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; }
    .view-btn { background: #334e68; color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: auto; margin-right: 5px; }
    .reset-btn { background: #6b46c1; color: white; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-right: 4px; margin-top: 5px; border-radius: 3px; }
    .fire-btn { background: #e53e3e; color: white; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; border-radius: 3px; }
    select.role-select { width: auto; padding: 2px; font-size: 11px; margin-left: 10px; background: #001226; }
  </style>
</head>
<body>
  <div class="nav-links"><a href="dashboard.html" class="btn-small">← Dashboard</a></div>

  <div class="admin-grid">
    <div>
      <div class="admin-container">
        <h2>Authorize Access</h2>
        <input type="email" id="inviteEmail" placeholder="Email">
        <input type="number" id="inviteRobloxId" placeholder="Roblox ID">
        <button class="action-btn" id="sendInviteBtn">Authorize</button>
      </div>
      <div class="admin-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Personnel Management</h2>
            <button class="reset-btn" id="resetAllWeeklyBtn" style="background: #e53e3e; padding: 5px 10px;">RESET ALL WEEKLY</button>
        </div>
        <div id="userList" class="user-list-container">Loading personnel...</div>
      </div>
    </div>

    <div>
      <div class="admin-container" id="typeManager" style="display:none;">
        <h2>Event Type Management</h2>
        <input type="text" id="newTypeName" placeholder="e.g. Basic Combat Training">
        <button class="action-btn" id="addTypeBtn">Add Event Type</button>
        <div id="typeList" style="margin-top:10px; font-size:12px;"></div>
      </div>

      <div class="admin-container">
        <h2>Awaiting Approval (Events)</h2>
        <div id="logQueue" class="log-queue">No pending event logs.</div>
      </div>

      <div class="admin-container" style="border-top-color: #9f7aea;">
        <h2 style="color: #9f7aea;">Awaiting Approval (Minutes)</h2>
        <div id="minutesQueue" class="log-queue">No pending minutes logs.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, 
      updateDoc, deleteDoc, addDoc, getDocs, writeBatch, increment,
      query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const roles = ["User", "HICOM", "Director", "Headquarters", "SECNAV", "Admin"];
    let currentUserUid = "";
    let myRoleName = "User";
    let myHierarchyIndex = 0;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");
      currentUserUid = user.uid;
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (!userSnap.exists()) return window.location.replace("dashboard.html");
      const data = userSnap.data();
      myRoleName = data?.role || "User";
      myHierarchyIndex = roles.indexOf(myRoleName);
      if (myHierarchyIndex < 1) return window.location.replace("dashboard.html");
      if (myHierarchyIndex >= 2) document.getElementById("typeManager").style.display = "block";

      loadUsers();
      loadEventTypes();
      loadPendingLogs();
      loadPendingMinutes();
    });

    document.getElementById("resetAllWeeklyBtn").onclick = async () => {
        if (!confirm("CONFIRMATION: Reset WEEKLY events AND minutes for EVERYONE?")) return;
        const usersSnap = await getDocs(collection(db, "users"));
        const batch = writeBatch(db);
        usersSnap.forEach(uDoc => { 
            batch.update(uDoc.ref, { weeklyEvents: 0, weeklyMinutes: 0 }); 
        });
        await batch.commit();
        alert("All weekly counters reset.");
    };

    async function loadUsers() {
      onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(uDoc => {
          const u = uDoc.data();
          const targetRoleIndex = roles.indexOf(u.role || "User");
          const div = document.createElement("div");
          div.className = "card";
          const isMe = uDoc.id === currentUserUid;
          const canManage = !isMe && myHierarchyIndex > targetRoleIndex;

          let roleHTML = `Role: ${u.role}`;
          if (canManage) {
            roleHTML = `<select class="role-select" onchange="window.updateRole('${uDoc.id}', this.value, '${u.email}')">`;
            roles.forEach((r, idx) => { if (idx < myHierarchyIndex) roleHTML += `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`; });
            roleHTML += `</select>`;
          }

          div.innerHTML = `
            <strong>${u.email}</strong><br>
            ${roleHTML}<br>
            <div style="margin-top:5px; color:#cbd5e0; line-height: 1.4;">
                Events: W: ${u.weeklyEvents || 0} | P: ${u.promoEvents || 0} | C: ${u.totalEvents || 0}<br>
                Minutes: W: ${u.weeklyMinutes || 0} | P: ${u.promoMinutes || 0} | C: ${u.totalMinutes || 0}
            </div>
            ${canManage ? `
                <div style="margin-top:8px;">
                    <button class="reset-btn" onclick="window.resetIndividual('${uDoc.id}', 'weekly', '${u.email}')">Reset Weekly</button>
                    <button class="reset-btn" onclick="window.resetIndividual('${uDoc.id}', 'promo', '${u.email}')">Reset Promo</button>
                    <button class="reset-btn" onclick="window.resetIndividual('${uDoc.id}', 'career', '${u.email}')">Reset Career</button>
                    <button class="fire-btn" onclick="window.fireUser('${uDoc.id}', '${u.email}')">FIRE USER</button>
                </div>
            ` : ''}
          `;
          list.appendChild(div);
        });
      });
    }

    window.fireUser = async (uid, email) => {
        if (!confirm(`FINAL WARNING: Are you firing ${email}? This will delete their portal account and all associated data.`)) return;
        await deleteDoc(doc(db, "users", uid));
        alert(`${email} has been removed from the portal.`);
    };

    window.updateRole = async (uid, newRole, email) => {
        if (confirm(`Change ${email}'s role to ${newRole}?`)) await updateDoc(doc(db, "users", uid), { role: newRole });
    };

    window.resetIndividual = async (uid, type, email) => {
        if (!confirm(`Reset ALL ${type} stats (Events & Minutes) for ${email}?`)) return;
        const updates = {};
        if (type === 'weekly') { updates.weeklyEvents = 0; updates.weeklyMinutes = 0; }
        if (type === 'promo') { updates.promoEvents = 0; updates.promoMinutes = 0; }
        if (type === 'career') { updates.totalEvents = 0; updates.totalMinutes = 0; }
        await updateDoc(doc(db, "users", uid), updates);
    };

    document.getElementById("addTypeBtn").onclick = async () => {
      const name = document.getElementById("newTypeName").value.trim();
      if (!name) return;
      await addDoc(collection(db, "event_types"), { name });
      document.getElementById("newTypeName").value = "";
    };

    function loadEventTypes() {
      onSnapshot(collection(db, "event_types"), (snap) => {
        const list = document.getElementById("typeList");
        list.innerHTML = "";
        snap.forEach(d => {
          const item = document.createElement("div");
          item.style.marginBottom = "5px";
          item.innerHTML = `• ${d.data().name} <button style="width:auto; padding:2px 8px; background:red; border:none; cursor:pointer;" onclick="window.confirmDeleteType('${d.id}', '${d.data().name}')">Delete</button>`;
          list.appendChild(item);
        });
      });
    }

    window.confirmDeleteType = (id, name) => { if(confirm(`Delete "${name}"?`)) deleteDoc(doc(db, "event_types", id)); };

    function loadPendingLogs() {
      onSnapshot(collection(db, "event_pending"), (snap) => {
        const queue = document.getElementById("logQueue");
        queue.innerHTML = snap.empty ? "No pending logs." : "";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>Type:</strong> ${data.type}<br>
            <strong>Host:</strong> ${data.hostEmail}<br>
            <button class="view-btn" onclick="window.viewProof('${d.id}', 'event_pending')">View Proof</button>
            <button class="approve-btn" onclick="window.processLog('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processLog('${d.id}', false)">Deny</button>
          `;
          queue.appendChild(card);
        });
      });
    }

    function loadPendingMinutes() {
      onSnapshot(collection(db, "minutes_pending"), (snap) => {
        const queue = document.getElementById("minutesQueue");
        queue.innerHTML = snap.empty ? "No pending minutes." : "";
        snap.forEach(d => {
          const data = d.data();
          const card = document.createElement("div");
          card.className = "card";
          card.style.borderLeftColor = "#9f7aea";
          card.innerHTML = `
            <strong>Activity:</strong> ${data.type}<br>
            <strong>Minutes:</strong> ${data.minutes}<br>
            <strong>User:</strong> ${data.hostEmail}<br>
            <button class="view-btn" onclick="window.viewProof('${d.id}', 'minutes_pending')">View Proof</button>
            <button class="approve-btn" onclick="window.processMinutes('${d.id}', true)">Approve</button>
            <button class="deny-btn" onclick="window.processMinutes('${d.id}', false)">Deny</button>
          `;
          queue.appendChild(card);
        });
      });
    }

    window.viewProof = async (logId, collName) => {
        const chunksSnap = await getDocs(query(collection(db, `${collName}/${logId}/chunks`), orderBy("index")));
        let fullBase64 = "";
        chunksSnap.forEach(chunk => fullBase64 += chunk.data().data);
        const win = window.open("");
        win.document.write(`<img src="data:image/png;base64,${fullBase64}" style="max-width:100%;">`);
    };

    window.processLog = async (logId, approved) => {
      try {
        if(!confirm(`Confirm ${approved ? 'Approval' : 'Denial'}?`)) return;
        const logRef = doc(db, "event_pending", logId);
        const logSnap = await getDoc(logRef);
        if(!logSnap.exists()) return;
        const data = logSnap.data();

        if (approved) {
          const batch = writeBatch(db);
          let participants = [data.hostEmail, ...(data.coHosts || []), ...(data.supervisors || [])];
          participants = [...new Set(participants.filter(e => e && e !== "None"))];

          for (const email of participants) {
            const q = query(collection(db, "users"), where("email", "==", email));
            const uSnap = await getDocs(q);
            if (!uSnap.empty) {
                batch.update(uSnap.docs[0].ref, { 
                    totalEvents: increment(1), 
                    promoEvents: increment(1), 
                    weeklyEvents: increment(1) 
                });
            }
          }
          batch.set(doc(collection(db, "event_history")), { ...data, approvedAt: new Date(), approvedBy: auth.currentUser.email });
          batch.delete(logRef);
          await batch.commit();
        } else { await deleteDoc(logRef); }
        alert("Action complete.");
      } catch (e) { alert("Error: " + e.message); }
    };

    window.processMinutes = async (logId, approved) => {
      try {
        if(!confirm(`Confirm ${approved ? 'Approval' : 'Denial'} for Minutes?`)) return;
        const logRef = doc(db, "minutes_pending", logId);
        const logSnap = await getDoc(logRef);
        if(!logSnap.exists()) return;
        const data = logSnap.data();

        if (approved) {
          const batch = writeBatch(db);
          const q = query(collection(db, "users"), where("email", "==", data.hostEmail));
          const uSnap = await getDocs(q);
          
          if (!uSnap.empty) {
              batch.update(uSnap.docs[0].ref, { 
                  totalMinutes: increment(data.minutes),
                  promoMinutes: increment(data.minutes),
                  weeklyMinutes: increment(data.minutes)
              });
          }
          
          batch.set(doc(collection(db, "event_history")), { ...data, approvedAt: new Date(), approvedBy: auth.currentUser.email });
          batch.delete(logRef);
          await batch.commit();
        } else { await deleteDoc(logRef); }
        alert("Minutes action complete.");
      } catch (e) { alert("Error: " + e.message); }
    };

    document.getElementById("sendInviteBtn").onclick = async () => {
      const email = document.getElementById("inviteEmail").value.toLowerCase().trim();
      const rid = document.getElementById("inviteRobloxId").value;
      if(!email) return alert("Email required");
      await setDoc(doc(db, "pending_invites", email), { robloxUserId: rid, invitedAt: new Date(), invitedBy: auth.currentUser.email });
      alert("Authorized");
    };
  </script>
</body>
</html>