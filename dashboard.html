<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | NETC Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; text-align: center; background: #001226; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; }
    .nav-links { width: 100%; max-width: 800px; display: flex; justify-content: flex-end; margin-bottom: 20px; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #e2b13c; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 12px; text-transform: uppercase; }
    .dashboard-container { background: rgba(0, 30, 60, 0.6); padding: 30px; border-radius: 8px; border-top: 3px solid #e2b13c; width: 100%; max-width: 600px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    h1 { color: #e2b13c; margin: 0; text-transform: uppercase; font-size: 24px; }
    #roleDisplay { color: #e2b13c; margin: 5px 0 20px 0; font-size: 18px; }
    
    .stats-header { font-size: 11px; color: #718096; text-transform: uppercase; margin: 25px 0 10px 0; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
    
    .progress-section { margin-bottom: 12px; text-align: left; }
    .progress-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; }
    .progress-bar-bg { background: rgba(255,255,255,0.05); height: 8px; border-radius: 4px; border: 1px solid rgba(226, 177, 60, 0.2); overflow: hidden; }
    .progress-fill { background: #e2b13c; height: 100%; width: 0%; transition: width 0.8s; }

    .stat-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
    .stat-box span { display: block; font-size: 22px; font-weight: bold; color: #e2b13c; }
    .stat-box label { font-size: 9px; color: #718096; text-transform: uppercase; }

    .btn-group { display: flex; gap: 10px; flex-direction: column; margin-top: 25px; }
    .action-btn { background: #e2b13c; color: #001226; padding: 12px; border: none; border-radius: 4px; font-weight: bold; text-decoration: none; font-size: 14px; }
    #resignBtn { margin-top: 40px; background: none; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 8px; cursor: pointer; border-radius: 4px; font-size: 11px; }
  </style>
</head>
<body>

  <div class="nav-links">
    <a href="admin.html" id="adminLink" class="btn-small" style="display: none;">Admin Panel</a>
  </div>

  <div class="dashboard-container">
    <h1>NETC Portal</h1>
    <div id="roleDisplay">Loading...</div>

    <div class="stats-header">Career Statistics</div>
    <div class="stat-box-grid">
      <div class="stat-box"><span id="cEvents">0</span><label>Lifetime Events</label></div>
      <div class="stat-box"><span id="cMins">0</span><label>Lifetime Minutes</label></div>
    </div>

    <div class="stats-header">Divisions Weekly Statistics</div>
    <div class="stat-box-grid" style="margin-bottom: 20px;">
      <div class="stat-box"><span id="gEvents">0</span><label>Total Events</label></div>
      <div class="stat-box"><span id="gMins">0</span><label>Total Minutes</label></div>
    </div>

    <div class="stats-header">Weekly Quota Progress</div>
    <div id="quotaContainer"></div>

    <div class="stats-header">Promotion Progress</div>
    <div id="promoContainer"></div>

    <div class="btn-group">
      <a href="eventlogs.html" class="action-btn">Submit Event Log</a>
      <a href="minuteslogs.html" class="action-btn" style="background: #9f7aea; color: white;">Submit Minutes Log</a>
    </div>

    <button id="logoutBtn" style="margin-top: 20px; background:none; border:none; color:#718096; cursor:pointer;">Logout</button>
    <button id="resignBtn">RESIGN (DELETE ACCOUNT)</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import firebaseConfig from './config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.replace("index.html");

      onSnapshot(doc(db, "users", user.uid), async (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        const rank = data.role || "User";
        document.getElementById("roleDisplay").textContent = rank;
        document.getElementById("cEvents").textContent = data.totalEvents || 0;
        document.getElementById("cMins").textContent = data.totalMinutes || 0;

        // Admin Access
        const staff = ["hicom", "deputy director", "director", "headquarters", "secnav", "commander in chief", "admin"];
        if (staff.includes(rank.toLowerCase())) document.getElementById("adminLink").style.display = "block";

        // Requirements Fetching
        const qReqSnap = await getDoc(doc(db, "quotas", rank));
        const pReqSnap = await getDoc(doc(db, "requirements", rank));
        
        const qReq = qReqSnap.exists() ? qReqSnap.data() : { tryouts: 0, bootcamps: 0, other: 0, minutes: 0 };
        const pReq = pReqSnap.exists() ? pReqSnap.data() : { tryouts: 0, bootcamps: 0, other: 0, minutes: 0 };

        renderBars("quotaContainer", data.quota, qReq);
        renderBars("promoContainer", data.promo, pReq);
      });

      // Divisions Statistics
      onSnapshot(collection(db, "users"), (snap) => {
        let e = 0, m = 0;
        snap.forEach(d => {
          const u = d.data();
          e += (u.quota?.tryouts || 0) + (u.quota?.bootcamps || 0) + (u.quota?.other || 0);
          m += (u.quota?.minutes || 0);
        });
        document.getElementById("gEvents").textContent = e;
        document.getElementById("gMins").textContent = m;
      });

      document.getElementById("resignBtn").onclick = async () => {
        if(confirm("Are you sure you want to resign? This deletes your account forever.")){
          await deleteDoc(doc(db, "users", user.uid));
          await deleteUser(user);
          window.location.replace("index.html");
        }
      };
    });

    function renderBars(containerId, current, required) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";
      const fields = ["tryouts", "bootcamps", "other", "minutes"];
      fields.forEach(f => {
        const cur = current?.[f] || 0;
        const req = required?.[f] || 0;
        const perc = req <= 0 ? 100 : Math.min((cur/req)*100, 100);
        cont.innerHTML += `
          <div class="progress-section">
            <div class="progress-label"><span>${f.toUpperCase()}</span><span>${cur}/${req}</span></div>
            <div class="progress-bar-bg"><div class="progress-fill" style="width:${perc}%"></div></div>
          </div>`;
      });
    }

    document.getElementById("logoutBtn").onclick = () => signOut(auth);
  </script>
</body>
</html>